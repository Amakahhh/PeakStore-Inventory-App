// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  STAFF
}

enum SaleType {
  RETAIL      // Unit
  WHOLESALE   // Carton
  ROLL        // Pack/Roll (Sub-carton)
}

enum StockChangeReason {
  RESTOCK
  DAMAGE
  CORRECTION
  BREAK_CARTON
  BREAK_ROLL   // Added for roll logic
  OTHER
}

enum PaymentMethod {
  CASH
  POS
  TRANSFER
}

model PaymentAccount {
  id        String   @id @default(uuid())
  name      String
  type      String   // e.g., 'BANK', 'POS_TERMINAL'
  details   String?  // bank account number, terminal ID, etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sales     Sale[] // Direct link to individual sales (legacy) or through Invoice
  invoices  Invoice[]
  purchases Purchase[]
  outgoingTransactions Transaction[] @relation("FromAccount")
  incomingTransactions Transaction[] @relation("ToAccount")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      Role     @default(STAFF)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sales     Sale[]
  invoices  Invoice[]
  purchases Purchase[]
  transactions Transaction[]
  audits    StockAudit[]
}

model Item {
  id                  String   @id @default(uuid())
  name                String
  category            String?
  
  // Pricing
  wholesalePrice      Decimal  @default(0) // Price per carton
  rollPrice           Decimal  @default(0) // Price per roll
  retailPrice         Decimal  @default(0) // Price per unit
  costPrice           Decimal  @default(0) // Cost Price (Normalized to Smallest Unit)
  
  // Configuration
  wholesaleQuantity   Int      @default(0) // Items in a wholesale pack (Legacy?)
  rollsPerCarton      Int      @default(0) 
  unitsPerRoll        Int      @default(0) 
  retailPerCarton     Int      @default(1) // Total units in a carton
  
  // Unit Type Flags - Track which units this item is sold in
  soldInCartons       Boolean  @default(true)
  soldInRolls         Boolean  @default(false)
  soldInUnits         Boolean  @default(true)
  
  // Inventory State
  currentStockCartons Int      @default(0)
  currentStockRolls   Int      @default(0)
  currentStockUnits   Int      @default(0)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  sales               Sale[]
  purchases           Purchase[]
  priceHistory        PriceHistory[]
  stockAudits         StockAudit[]
}


model Customer {
  id        String    @id @default(uuid())
  name      String
  phone     String?   @unique
  email     String?
  address   String?
  totalTabs Decimal   @default(0)
  
  invoices  Invoice[]
  sales     Sale[]    // Direct link to sales history
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Invoice {
  id               String          @id @default(uuid())
  invoiceNumber    Int             @default(autoincrement()) // Simple sequential number for humans
  
  customerName     String?         // Snapshot/Legacy
  customerId       String?
  customer         Customer?       @relation(fields: [customerId], references: [id])
  
  notes            String?
  
  totalAmount      Decimal
  
  paymentMethod    PaymentMethod   @default(CASH)
  paymentAccountId String?
  paymentAccount   PaymentAccount? @relation(fields: [paymentAccountId], references: [id])
  
  userId           String
  user             User            @relation(fields: [userId], references: [id])
  
  sales            Sale[]          // Items in this invoice
  
  createdAt        DateTime        @default(now())
}

model Sale {
  id               String          @id @default(uuid())
  itemId           String
  item             Item            @relation(fields: [itemId], references: [id])
  userId           String          // Staff who made the sale
  user             User            @relation(fields: [userId], references: [id])
  
  invoiceId        String?         // Link to parent invoice
  invoice          Invoice?        @relation(fields: [invoiceId], references: [id])
  
  customerId       String?
  customer         Customer?       @relation(fields: [customerId], references: [id])
  
  quantity         Int
  saleType         SaleType
  priceAtTime      Decimal
  costPriceAtTime  Decimal         @default(0)
  totalAmount      Decimal
  
  // Legacy/Redundant if linked to Invoice, but kept for direct querying if needed
  paymentMethod    PaymentMethod?
  paymentAccountId String?
  paymentAccount   PaymentAccount? @relation(fields: [paymentAccountId], references: [id])
  
  createdAt        DateTime        @default(now())
}

model PriceHistory {
  id              String   @id @default(uuid())
  itemId          String
  item            Item     @relation(fields: [itemId], references: [id])
  oldWholesale    Decimal
  newWholesale    Decimal
  oldRetail       Decimal
  newRetail       Decimal
  changedBy       String?
  changedAt       DateTime @default(now())
}

model StockAudit {
  id              String            @id @default(uuid())
  itemId          String
  item            Item              @relation(fields: [itemId], references: [id])
  userId          String
  user            User              @relation(fields: [userId], references: [id])
  changeCartons   Int
  changeUnits     Int
  reason          StockChangeReason
  note            String?
  createdAt       DateTime          @default(now())
}

model Purchase {
  id               String          @id @default(uuid())
  itemId           String
  item             Item            @relation(fields: [itemId], references: [id])
  userId           String
  user             User            @relation(fields: [userId], references: [id])
  quantity         Int
  unitType         SaleType        @default(WHOLESALE) 
  costPrice        Decimal         
  totalCost        Decimal
  
  paymentAccountId String?
  paymentAccount   PaymentAccount? @relation(fields: [paymentAccountId], references: [id])
  
  notes            String?
  createdAt        DateTime        @default(now())
}

model Transaction {
  id                 String          @id @default(uuid())
  amount             Decimal
  type               TransactionType 
  
  fromAccountId      String?
  fromAccount        PaymentAccount? @relation("FromAccount", fields: [fromAccountId], references: [id])
  
  toAccountId        String?
  toAccount          PaymentAccount? @relation("ToAccount", fields: [toAccountId], references: [id])
  
  description        String?
  userId             String
  user               User            @relation(fields: [userId], references: [id])
  
  createdAt          DateTime        @default(now())
}

enum TransactionType {
  TRANSFER
  WITHDRAWAL
  DEPOSIT
}
